# yaml-language-server: $schema=https://raw.githubusercontent.com/Azure/azure-dev/main/schemas/v1.0/azure.yaml.json

name: app-mod-aks
metadata:
  template: app-mod-aks@0.0.1-beta

# Services for the three applications
services:
  python-app:
    language: python
    host: aks
    project: ./python-app
    resourceName: AKS_CLUSTER_NAME
    k8s:
      deploymentPath: ./manifests/python-app.yaml
    
  js-app:
    language: js
    host: aks
    project: ./js-app
    resourceName: AKS_CLUSTER_NAME
    k8s:
      deploymentPath: ./manifests/js-app.yaml
    
  java-app:
    language: java
    host: aks
    project: ./java-app
    resourceName: AKS_CLUSTER_NAME
    k8s:
      deploymentPath: ./manifests/java-app.yaml

# Hooks to set environment variables after provisioning
hooks:
  postprovision:
    shell: sh
    run: |
      echo "Setting AKS cluster environment variables..."
      CLUSTER_NAME=$(azd env get-value AKS_CLUSTER_NAME)
      RESOURCE_GROUP=$(azd env get-value AZURE_RESOURCE_GROUP)
      
      if [ -n "$CLUSTER_NAME" ]; then
        azd env set AZURE_AKS_CLUSTER_NAME "$CLUSTER_NAME"
        echo "Set AZURE_AKS_CLUSTER_NAME=$CLUSTER_NAME"
      fi
      
      if [ -n "$RESOURCE_GROUP" ]; then
        azd env set AZURE_RESOURCE_GROUP "$RESOURCE_GROUP"
        echo "Set AZURE_RESOURCE_GROUP=$RESOURCE_GROUP"
      fi
